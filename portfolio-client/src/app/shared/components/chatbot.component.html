<p-dialog [(visible)]="visible" [modal]="true" [resizable]="true" [draggable]="true" [closeOnEscape]="true"
  header="Discuter avec Paul" [style]="{width: '500px', height: '700px'}" styleClass="chatbot-dialog"
  [maximizable]="true" (onHide)="onHide()">

  <!-- Messages Container -->
  <div class="flex flex-col h-full">
    <!-- Header decoration -->
    <div class="h-1 w-full bg-gradient-to-r from-primary-500 to-primary-300"></div>

    <!-- Chat Messages Area -->
    <div class="flex-1 overflow-y-auto flex flex-col gap-6 py-6 px-4" #messagesContainer>

      <!-- Welcome Message if Empty -->
      <div *ngIf="messages.length === 0"
        class="flex flex-col items-center justify-center flex-1 opacity-60 mt-10 mb-auto">
        <div class="w-16 h-16 rounded-full bg-primary-100 dark:bg-primary-900/30 flex items-center justify-center mb-4">
          <i class="pi pi-user text-2xl text-primary-500"></i>
        </div>
        <h3 class="font-semibold text-lg">Bonjour, je suis Paul</h3>
        <p class="text-sm text-center max-w-xs mt-2">Bienvenue sur mon portfolio. Je suis là pour répondre à toutes vos
          questions sur mon travail !</p>
      </div>

      <!-- Message Item -->
      <div *ngFor="let message of messages; trackBy: trackByIndex" class="flex items-start max-w-[85%] group" [ngClass]="{
          'ml-auto flex-row-reverse': message.role === 'user',
          'mr-auto': message.role === 'assistant'
        }">

        <!-- Message Header with Avatar -->
        <div class="flex-shrink-0" [ngClass]="message.role === 'user' ? 'ml-3' : 'mr-3'">
          <p-avatar shape="circle" size="large"
            [image]="message.role === 'assistant' ? 'assets/images/profile.jpg' : undefined"
            [icon]="message.role === 'user' ? 'pi pi-user' : undefined"
            [styleClass]="message.role === 'user' ? 'bg-primary-100 text-primary-700' : 'bg-surface-200'">
          </p-avatar>
        </div>

        <!-- Message Content -->
        <div class="flex-1 px-3 py-2 rounded-lg"
          [style]="message.role === 'user' ? 'background: var(--primary-color); color: var(--primary-color-text)' : (message.isError ? 'background: #fee2e2; color: #991b1b; border: 1px solid #f87171' : 'background: var(--surface-card); color: var(--text-color); border: 1px solid var(--surface-border)')"
          [ngClass]="{'border-red-500 bg-red-50 dark:bg-red-900/20 dark:text-red-300': message.isError}">

          <!-- Message Text -->
          <div *ngIf="message.role === 'user'; else assistantMessage">
            <p class="leading-6 mb-0 whitespace-pre-wrap" [innerHTML]="formatMessage(message.content)">
            </p>
          </div>
          <ng-template #assistantMessage>
            <div class="leading-6 mb-0 text-color whitespace-pre-wrap">
              <app-markdown-block [markdown]="message.content"></app-markdown-block>
            </div>
          </ng-template>


          <!-- Message Time with Typing indicator -->
          <div class="flex items-center justify-between text-xs mt-1 opacity-70">
            <span>{{ formatTime(message.timestamp) }}</span>

            <!-- Typing indicator for assistant messages being streamed -->
            <!-- Typing indicator for assistant messages being streamed -->
            <div *ngIf="message.role === 'assistant' && message.isStreaming" class="flex flex-col gap-1">
              <div class="flex gap-1">
                <div class="w-1.5 h-1.5 bg-current rounded-full animate-pulse" style="animation-delay: 0ms;"></div>
                <div class="w-1.5 h-1.5 bg-current rounded-full animate-pulse" style="animation-delay: 150ms;"></div>
                <div class="w-1.5 h-1.5 bg-current rounded-full animate-pulse" style="animation-delay: 300ms;"></div>
              </div>
              <div *ngIf="currentStatus" class="status-message">{{ currentStatus }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Standalone Status for "Thinking..." phase -->
      <div *ngIf="isLoading && (messages.length > 0 && messages[messages.length - 1].role === 'user')"
        class="flex items-start max-w-[85%] mr-auto group animate-fade-in">
        <div class="flex-shrink-0 mr-3">
          <p-avatar shape="circle" size="large" image="assets/images/profile.jpg" styleClass="bg-surface-200">
          </p-avatar>
        </div>
        <div class="flex-1 px-3 py-2 rounded-lg"
          style="background: var(--surface-card); color: var(--text-color); border: 1px solid var(--surface-border)">
          <div class="flex items-center gap-2">
            <div class="flex gap-1">
              <div class="w-1.5 h-1.5 bg-current rounded-full animate-pulse" style="animation-delay: 0ms;"></div>
              <div class="w-1.5 h-1.5 bg-current rounded-full animate-pulse" style="animation-delay: 150ms;"></div>
              <div class="w-1.5 h-1.5 bg-current rounded-full animate-pulse" style="animation-delay: 300ms;"></div>
            </div>
            <span class="text-xs italic opacity-70">{{ currentStatus || 'Réflexion en cours...' }}</span>
          </div>
        </div>
      </div>

    </div>

    <!-- Input Section -->
    <div class="border-t border-surface-200 dark:border-surface-700 pt-4 mt-4">
      <!-- Quick Actions -->
      <div class="flex flex-wrap gap-2 mb-4" *ngIf="messages.length === 0">
        <p-button label="Mon parcours" size="small" severity="secondary" [outlined]="true" styleClass="text-xs"
          (onClick)="askQuickQuestion('Peux-tu me parler de ton parcours professionnel ?')">
        </p-button>
        <p-button label="Mes projets" size="small" severity="secondary" [outlined]="true" styleClass="text-xs"
          (onClick)="askQuickQuestion('Quels sont tes principaux projets ?')">
        </p-button>
        <p-button label="Mes compétences" size="small" severity="secondary" [outlined]="true" styleClass="text-xs"
          (onClick)="askQuickQuestion('Quelles sont tes compétences techniques ?')">
        </p-button>
      </div>

      <!-- Input Container -->
      <div class="flex gap-2 items-end">
        <div class="flex-1">
          <div #messageInput contenteditable="true"
            class="w-full min-h-[40px] max-h-[120px] overflow-y-auto p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all"
            style="background: var(--surface-card); color: var(--text-color); border: 1px solid var(--surface-border)"
            role="textbox" aria-multiline="true" [attr.disabled]="isLoading ? '' : null" (keydown)="onKeyDown($event)"
            (input)="onInput($event)" placeholder="Tapez votre message...">
          </div>
        </div>
        <div class="flex gap-1 items-start pb-2">
          <p-button icon="pi pi-send" [disabled]="!currentMessage.trim() || isLoading" (onClick)="sendMessage()"
            size="small" [rounded]="true" pTooltip="Envoyer (Ctrl+Entrée)">
          </p-button>
          <p-button icon="pi pi-history" severity="secondary" (onClick)="clearHistory()" size="small" [rounded]="true"
            [outlined]="true" pTooltip="Effacer l'historique">
          </p-button>
        </div>
      </div>
    </div>
  </div>
</p-dialog>